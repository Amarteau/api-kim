:imagesdir: ../images
:toc: macro
:toclevels: 3
:toc-title: Inhaltsverzeichnis
:numbered:

image:gematik_logo.jpg[width=35%]

toc::[]


== Clientmodul

Für KOM-LE 1.5 ist es notwendig das Clientmodul um Folgendes anzupassen:

* Optional kann der Funktionsumfang des Clientmoduls in das PVS integriert werden.
* Das Clientmodul wird für den Umgang mit großen Anhängen erweitert.
* Das Clientmodul wird für die Unterstützung von Mail-Kategorien erweitert.
* Das Clientmodul wird um das Administrationsmodul erweitert. 


=== Optionale Integration in das Clientsystem

Ab KOM-LE 1.5 kann der Funktionsumfang des Clientmodules in das PVS optional integriert werden. Somit ist kein seperates Clientmodul mehr notwendig.
Die folgende Abbildung verdeutlicht die optionale Integration in das PVS:

image:CM_Integration.png[width=60%]


=== Umgang mit großen Anhängen

Für die Aufhebung der Größenbeschränkungen von Nachrichten ist eine Erweiterung am Clientmodul notwendig. Wie das Clientmodul mit größeren Anhängen umgeht, ist in *[gemSpec_CM_KOMLE#3.2]* spezifiziert.


=== Umgang mit E-Mail-Kategorien

Das Clientmodul ermöglicht die Kategorisierung von zu versendenden E-Mails. Die Header-Felder einer gültigen E-Mail werden um ein weiteres Attribut ergänzt. Die Befüllung dieses Attributes erfolgt durch Informationen, die der E-Mail-Client liefert. Das Header-Feld "X-KIM-Dienstkennung" wird im unverschlüsselten Header der E-Mail enthalten sein, um eine eventuelle Verarbeitung der E-Mail auf Seiten des Empfängers zu ermöglichen. Die Anpassungen sind in  *[gemSpec_CM_KOMLE#3.6]* spezifiziert.


=== KIM-API vom KAS 

Die Aufrufe der Operationen vom Clientmodul zu der REST-Schnittstelle des KAS des Fachdienstes wird im Folgenden beschrieben.

==== add_Attachment() 
Ein verschlüsselter Anhang wird unter einem neu erzeugten Freigabe-Link hinzugefügt.

*Request-Header:*
[source]
-----------------
 Method: "POST"
 Request-URI: "https://kas.hersteller.kim.telematik/v1.1/"
 HTTP-Version: "HTTP/1.1
 Content-Type: "application/octect-stream"
-----------------

*Beispielantwort*
[source]
-----------------
Code: 201
Body:
{
  "Shared-Link":"https://kas.hersteller.kim.telematik/v1.1/b2deea19-c37f-4ef0-a95f-d4e8b5817824"
}

-----------------

*HTTP-Status Codes:* 
|===
|Status |Bedeutung

|201
|Created - Der Anhang wurde erfolgreich unter dem angegebenen Freigabelink hinzugefügt
|400
|Invalid Input
|413
|Payload Too Large
|===


*Beispielabfrage:*
[source]
-----------------
curl -X POST "https://kas.hrst1.kim.telematik/v1.1/" -H  "accept: application/json" -H  "Content-Type: application/octect-stream" -d binary-file
-----------------


==== read_Attachment() 
Gibt den unter einem Freigabelink verschlüsselten Anhang zurück.

*Request-Header:*
[source]
-----------------
 Method: "GET"
 Request-URI: "https://kas.hersteller.kim.telematik/v1.1/{Ressource}"
 HTTP-Version: "HTTP/1.1"
-----------------

Parameters: +

* `Ressource` - Freigabelink, unter dem der Anhang gespeichert wurde

*Beispielantwort*
[source]
-----------------
Code: 200
Body: <Datei-inhalt>
-----------------

*HTTP-Status Codes:*

|===
|Status |Bedeutung

|200
|OK - Anhang wurde erfolgreich heruntergeladen
|404
|Ressource unter dem angegebenen Link nicht gefunden
|===


*Beispielabfrage:*
[source]
-----------------
curl -X GET "https://kas.hersteller.kim.telematik/v1.1/b2deea19-c37f-4ef0-a95f-d4e8b5817824" -H "accept: application/octect-stream"
----------------- 

==== read_MaxMailSize() 
Gibt die maximale Größe einer gesamten KOM-LE-Mail inklusive aller Anhänge (Mail base64 kodiert) zurück. 
Mit diesem Wert prüft das Clientmodul die Einhaltung der maximalen Mail Größe (die vom Fachdienst-Anbieter definiert wird) für zu sendende Mails.
Dieser Wert wird auf dem Fachdienst definiert, und bleibt über längere Zeit konstant.
Eine Abfrage ist deshalb nicht für jede zu sendende Mail erforderlich (Empfohlen wird die tägliche Abfrage).

*Request-Header:*
[source]
-----------------
 Method: "GET"
 Request-URI: "https://kas.hersteller.kim.telematik/v1.1/MaxMailSize"
 HTTP-Version: "HTTP/1.1"
-----------------

*Beispielantwort:*
[source]
-----------------
Code: 200
Body:
{
  "MaxMailSize": 524288000
}
-----------------


*HTTP-Status Codes:*

|===
|Status |Bedeutung

|200
|OK - Maximale Mail-Größe wird in Bytes zurückgegeben
|===


*Beispielabfrage:*
[source]
-----------------
curl -X GET "https://kas.hersteller.kim.telematik/v1.1/MaxMailSize" -H  "accept: application/json"
----------------- 

== Administrationsmodul

=== KIM-API vom Account Manager

Die Aufrufe der Operationen vom Administrationsmodul zu der REST-Schnittstelle des Account Managers des Fachdienstes wird im Folgenden beschrieben. 

==== register() 
Ausführung der Registrierung und Download der PKCS#12-Datei.

*Request-Header:*
[source]
-----------------
 Method: "PUT"
 Request-URI: "https://account-manager.hersteller.kim.telematik/v1.1/accmgr/register/"
 HTTP-Version: "HTTP/1.1"
 username: "gematik@gematik.de"
 referenceID: "gematik2020"
 password: "gematik"
 nonce: "123456789"
 timestamp: "20200815"
 cert: "abcdefghijk"
 signedHash: "abcdefghijk"
-----------------

*Beispielantwort:*
[source]
-----------------
Code: 200
Body: <Datei-inhalt>
-----------------


*HTTP-Status Codes:* + 
|===
|Status |Bedeutung

|200
|OK - Die Anfrage wurde erfolgreich bearbeitet und Daten für den Download hinzugefügt
|401
|Unauthorized - Nutzername / Passwort
|===


*Beispielabfrage:*
[source]
-----------------
curl -X PUT "https://account-manager.hrst1.kim.telematik/v1.1/accmgr/register/" -H  "accept: application/octet-stream" -H  "username: gematik@gematik.de" -H  "referenceID: gematik2020" -H  "password: gematik" -H  "nonce: 123456789" -H  "timestamp: 20200815" -H  "cert: abcdefghijk" -H  "signedHash: abcdefghijk"
----------------- 

==== deregister()
Anmeldung am Account Manager und Ausführung der Deregistrierung.

*Request-Header:*
[source]
-----------------
 Method: "DELETE"
 Request-URI: "https://account-manager.hersteller.kim.telematik/v1.1/accmgr/deregister/"
 HTTP-Version: "HTTP/1.1"
 username: "gematik@gematik.de"
 password: "gematik"
 nonce: "123456789"
 timestamp: "20200815"
 cert: "abcdefghijk"
 signedHash: "abcdefghijk"
-----------------

*Beispielantwort:*
[source]
-----------------
Code: 200
-----------------


*HTTP-Status Codes:* + 
|===
|Status |Bedeutung

|200
|OK - Die Anfrage wurde erfolgreich bearbeitet
|401
|Unauthorized - Nutzername / Passwort
|===


*Beispielabfrage:*
[source]
-----------------
curl -X DELETE "https://account-manager.hrst1.kim.telematik/v1.1/accmgr/deregister/" -H  "accept: */*" -H  "username: gematik@gematik.de" -H  "password: gematik" -H  "nonce: 123456789" -H  "timestamp: 20200815" -H  "cert: abcdefghijk" -H  "signedHash: abcdefghijk"
----------------- 


==== register_State()
Anmeldung am Account Manager mit gleichzeitiger Abfrage des Registrierungsstatus

*Request-Header:*
[source]
-----------------
 Method: "GET"
 Request-URI": "https://account-manager.hersteller.kim.telematik/v1.1/accmgr/register-state/"
 HTTP-Version: "HTTP/1.1"
 Content-Type: "application/json"
 username: "gematik@gematik.de"
 password: "gematik"
 nonce: "123456789"
 timestamp: "20200815"
 cert: "abcdefghijk"
 signedHash: "abcdefghijk"
-----------------

*Beispielantwort:*
[source]
-----------------
Code: 200
Body:
{
  "registerState": registered
}
-----------------


*HTTP-Status Codes:* + 
|===
|Status |Bedeutung

|200
|OK - OK - Die Anfrage wurde erfolgreich bearbeitet
|401
|Unauthorized - Nutzername / Passwort
|===


Beispielabfrage:
[source]
-----------------
curl -X GET "https://account-manager.hrst1.kim.telematik/v1.1/accmgr/register-state/" -H  "accept: application/json" -H  "username: gematik@gematik.de" -H  "password: gematik" -H  "nonce: 123456789" -H  "timestamp: 20200815" -H  "cert: abcdefghijk" -H  "signedHash: abcdefghijk"
----------------- 

==== cm_Version()
Übermittlung der KIM-Version.

*Request-Header:*
[source]
-----------------
 Method: "PUT",
 Request-URI: "https://account-manager.hersteller.kim.telematik/v1.1/accmgr/cm-version/"
 HTTP-Version: "HTTP/1.1
 Content-Type: "application/json"
 username: "gematik@gematik.de"
 password: "gematik"
 KIM-Version: "1.5"
 nonce: "123456789"
 timestamp: "20200815"
 cert: "abcdefghijk"
 signedHash: "abcdefghijk"
-----------------

*Beispielantwort:*
[source]
-----------------
Code: 200
-----------------


*HTTP-Status Codes:* + 
|===
|Status |Bedeutung

|200
|OK - Die Anfrage wurde erfolgreich bearbeitet
|401
|Unauthorized - Nutzername / Passwort
|===


*Beispielabfrage:*
[source]
-----------------
curl -X PUT "https://account-manager.hrst1.kim.telematik/v1.1/accmgr/cm-version/" -H  "accept: */*" -H  "username: gematik@gematik.de" -H  "password: gematik" -H  "KIM-Version: 1.5" -H  "nonce: 123456789" -H  "timestamp: 20200815" -H  "cert: abcdefghijk" -H  "signedHash: abcdefghijk"
----------------- 

==== pw_Change()
Die Kennwortänderung

*Request-Header:*
[source]
-----------------
 Method: "PUT"
 Request-URI": "https://account-manager.hersteller.kim.telematik/v1.1/accmgr/pw/"
 HTTP-Version": "HTTP/1.1"
 username: "gematik@gematik.de"
 password: "gematik"
 newPassword: "gematik01"
 nonce: "123456789"
 timestamp: "20200815"
 cert: "abcdefghijk"
 signedHash: "abcdefghijk"
-----------------

*Beispielantwort:*
[source]
-----------------
Code: 200
-----------------


*HTTP-Status Codes:* + 
|===
|Status |Bedeutung

|200
|OK - Die Anfrage wurde erfolgreich bearbeitet
|400
|Bad Request - Das neue Passwort entspricht nicht den Regeln
|401
|Unauthorized - Nutzername / Passwort
|===


*Beispielabfrage:*
[source]
-----------------
curl -X PUT "https://account-manager.hrst1.kim.telematik/v1.1/accmgr/pw/" -H  "accept: */*" -H  "username: gematik@gematik.de" -H  "password: gematik" -H  "newPassword: gematik01" -H  "nonce: 123456789" -H  "timestamp: 20200815" -H  "cert: abcdefghijk" -H  "signedHash: abcdefghijk"
----------------- 

